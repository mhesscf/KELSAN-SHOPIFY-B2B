{% comment %}
  @param product {Product}
    The product object in question

  @param selected_media {Media}
    The current selected media in the gallery

  @param aspect_ratio {string}
    The aspect ratio setting, which is either 'short', 'tall', or 'square'

  @param image_crop {boolean}
    Defines if the image should be cropped or not

  @param gallery_hover_zoom {String}
    This is the hover zoom setting, which is either 'disabled', 'separate', or 'replace'
{% endcomment %}


{% assign specialclass = "" %}
{% if product.selected_or_first_available_variant.compare_at_price %}
    {% if product.selected_or_first_available_variant.price < product.selected_or_first_available_variant.compare_at_price %}
        {% assign specialSavings = product.compare_at_price | minus: product.price %}
        {% assign endDate = product.selected_or_first_available_variant.metafields.plytix.special_enddate | date: '%s' %}
        {% assign startDate = product.selected_or_first_available_variant.metafields.plytix.special_startdate | date: '%s' %}
        {% assign nowTimestamp = 'now' | date: '%s' %}

        {% assign enddiffSeconds = endDate | minus: nowTimestamp %}
        {% assign enddiffDays = enddiffSeconds | divided_by: 3600 | divided_by: 24 %}

        {% assign startdiffSeconds = startDate | minus: nowTimestamp %}
        {% assign startdiffDays = startdiffSeconds | divided_by: 3600 | divided_by: 24 %}

        {% if enddiffDays >= -1 and  startdiffDays < 0 %}
            {% assign specialclass = "isspecial" %}
        {% endif %}
    {% endif %}
{% endif %}

{% if product.metafields.plytix.custom_hot_deal_message %}

    {% assign endDate = product.selected_or_first_available_variant.metafields.plytix.custom_hot_deal_to_date | date: '%s' %}
    {% assign startDate = product.selected_or_first_available_variant.metafields.plytix.custom_hot_deal_from_date | date: '%s' %}
    {% assign nowTimestamp = 'now' | date: '%s' %}
    {% assign enddiffSeconds = endDate | minus: nowTimestamp %}
    {% assign enddiffDays = enddiffSeconds | divided_by: 3600 | divided_by: 24 %}

    {% assign startdiffSeconds = startDate | minus: nowTimestamp %}
    {% assign startdiffDays = startdiffSeconds | divided_by: 3600 | divided_by: 24 %}

    {% if enddiffDays >= -1 and  startdiffDays < 0 %}
        {%- if shop.permanent_domain contains "cleanfreak-dev.myshopify.com" or shop.permanent_domain contains "cleanfreak-prod.myshopify.com"-%}
            {% assign specialclass = "isspecial" %}
        {% endif %}
    {% endif %}
{% endif %}


<div
  class="
    product-gallery--viewer
    {% if product.media.size > 0 %}
      product-gallery--has-media
    {% endif %}
  "
  data-gallery-viewer
>
    {% assign orgCounter = 0  %}

  {% for media in product.media %}
    <figure
      class="
        product-gallery--media
        product-gallery--{{ media.media_type }}
        {{ specialclass }}
      "
      tabindex="-1"
      {% if selected_media.id != media.id %}
        aria-hidden="true"
      {% else %}
        aria-hidden="false"
      {% endif %}
      data-gallery-figure
      data-gallery-index="{{ forloop.index0 }}"
      data-gallery-selected="{%- if selected_media.id == media.id -%}true{%- else -%}false{%- endif -%}"
      data-media="{{ media.id }}"
      data-media-type="{{ media.media_type }}"
      {% if media.media_type == 'image' %}
        {% assign max_zoom = 2400 %}
        {% assign zoom_height = media.height %}
        {% assign zoom_width = media.width %}
        {% if image_crop %}
          {% case aspect_ratio %}
          {% when 'short' %}
            {% assign min_width = media.height | times: 4 | divided_by: 3 %}
            {% if media.width > min_width %}
              {% assign zoom_width = min_width %}
            {% else %}
              {% assign zoom_height = media.width | times: 3 | divided_by: 4 %}
            {% endif %}
          {% when 'square' %}
            {% comment %} Square crop {% endcomment %}
            {% if media.height > media.width %}
              {% assign zoom_height = media.width %}
            {% else %}
              {% assign zoom_width = media.height %}
            {% endif %}
          {% when 'tall' %}
            {% assign min_width = media.height | times: 2 | divided_by: 3 %}
            {% if media.width > min_width %}
              {% assign zoom_width = min_width %}
            {% else %}
              {% assign zoom_height = media.width | times: 3 | divided_by: 2 %}
            {% endif %}
          {% endcase %}
        {% endif %}

        {% comment %} Adjust the image dimensions to be within the maximum zoom size {% endcomment %}
        {% if zoom_height > max_zoom or zoom_width > max_zoom %}
          {% assign crop_aspect_ratio = zoom_width | times: 1000 | divided_by: zoom_height %}
          {% if zoom_width > zoom_height %}
            {% assign zoom_width = max_zoom %}
            {% assign zoom_height = max_zoom | times: 1000 | divided_by: crop_aspect_ratio %}
          {% else %}
            {% assign zoom_height = max_zoom %}
            {% assign zoom_width = max_zoom | times: crop_aspect_ratio | divided_by: 1000 %}
          {% endif %}
        {% endif %}

        {% assign image_dimensions = zoom_width | append: 'x' | append: zoom_height %}

        {% if image_crop %}
          data-zoom="{{ media | img_url: image_dimensions, crop: 'center' }}"
        {% else %}
          data-zoom="{{ media | img_url: image_dimensions }}"
        {% endif %}
        data-image-height="{{ zoom_height }}"
        data-image-width="{{ zoom_width }}"
      {% endif %}
    >
      {% case media.media_type %}
      {% when 'image' %}
        <div
          class="product-gallery--image-background"
          {% if image_crop %}
            {%
              render 'rimg',
              img: media,
              size: 'x700',
              lazy: true,
              background: true
            %}
          {% endif %}
        >
            {% if specialclass != "" %}
                <div class="deal-rib"><img class="img-responsive" src="{{ 'corner-ribbon.png' | file_img_url: '260x' }}" alt="Hot Deal Image" /></div>
            {% endif %}
          {%
            render 'rimg',
            img: media,
            class: 'product-gallery--loaded-image img-responsive'
            size: 'x700',
            lazy: true,
            canvas: true
          %}
        </div>
      {% when 'external_video' %}
        {% assign external_video_url = media | external_video_url %}
        <div class="product-gallery--external-video">
          {%
            render 'video'
            url: external_video_url,
            cover: media.preview_image,
            slideshow: true,
            aspect_ratio: '16-9',
          %}
        </div>
      {% when 'model' %}
        {{ media | model_viewer_tag: image_size: '1024x', reveal: 'interaction' , toggleable: true, interaction-prompt-threshold: 0 }}
        <noscript>
          <img
            src="{{ media.preview_image | img_url: '1024x' }}"
            alt="{{ media.preview_image.alt | escape }}"
            width="{{ media.preview_image.width }}"
            height="{{ media.preview_image.height }}"
            loading="lazy"
          >
        </noscript>
      {% when 'video' %}
        {{ media | media_tag: image_size: '1024x' }}
      {% else %}
        {{ media | media_tag }}
      {% endcase %}
    </figure>
      {% assign orgCounter = orgCounter | plus: 1  %}
  {% else %}
    <figure
      class="
        product-gallery--media
        product-gallery--image
        product-gallery--image-placeholder
      "
    >
      {% if onboarding %}
        {{ 'product-1' | placeholder_svg_tag: 'placeholder--image' }}
      {% else %}
        {{ 'image' | placeholder_svg_tag: 'placeholder--image' }}
      {% endif %}
    </figure>
      {% assign orgCounter = orgCounter | plus: 1  %}
  {% endfor %}

    {% comment %}youtube video -------------------------------------------------------{% endcomment %}
    {% assign lvideo = product.metafields.plytix.local_video | split: ";" %}
    {% for vid in lvideo %}
        {% assign pyt = vid | split: "::" %}
        {% comment %}{% assign videoimg = "http://img.youtube.com/vi/" | append: pyt[0] | append: "/0.jpg" %}{% endcomment %}

        <figure class="
                product-gallery--media
                product-gallery--video
              " tabindex="-1"
                aria-hidden="false"
                data-gallery-figure=""
                data-gallery-index="{{orgCounter }}"
                data-gallery-selected="false"
                data-media="{{orgCounter }}"
                data-media-type="video"
               >
            <video controls="controls" style="width: 100%; height: auto;">
                <source src="https://cdn.shopify.com/videos/c/o/v/{{ pyt[0] }}" type="video/mp4" />
                Your browser does not support our video.
            </video>
            <div class="alttext">{{ pyt[1] }}</div>
        </figure>
        {% assign orgCounter = orgCounter | plus: 1  %}
    {% endfor %}

    {% comment %}youtube video -------------------------------------------------------{% endcomment %}
    {% assign pvideo = product.metafields.plytix.product_video | split: ";" %}
    {% for vid in pvideo %}
        {% assign pyt = vid | split: "::" %}
        {% comment %}{% assign videoimg = "http://img.youtube.com/vi/" | append: pyt[0] | append: "/0.jpg" %}{% endcomment %}

            <figure class="
                product-gallery--media
                product-gallery--video
              " tabindex="-1"
                    aria-hidden="false"
                    data-gallery-figure=""
                    data-gallery-index="{{orgCounter }}"
                    data-gallery-selected="false"
                    data-media="{{orgCounter }}"
                    data-media-type="video"
            data-mitch="{{ orgCounter }}">
            {% comment %}<div class="vid-contain">{% endcomment %}
                {% comment %}<iframe src="https://www.youtube.com/embed/{{ pyt[0] }}?modestbranding=1" frameborder="0" title="{{ pyt[1] | escape }}"></iframe>{% endcomment %}
                {% comment %}<div class="alttext">{{ pyt[1] }}</div>{% endcomment %}
            {% comment %}</div>{% endcomment %}

                {% if pyt[0] contains "vimeo" %}
                    {% assign vimeoid = pyt[0] | replace: "vimeo-","" %}
                    {% comment %}<iframe src="https://player.vimeo.com/video/474973525?h=9cd571a900&title=0&byline=0&portrait=0" width="640" height="360" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>{% endcomment %}
                    <iframe src="https://player.vimeo.com/video/{{ vimeoid }}?title=0&byline=0&portrait=0?loop=1&modestbranding=1" frameborder="0" title="{{ pyt[1] | escape }}"></iframe>
                {% else %}
                    <iframe src="https://www.youtube.com/embed/{{ pyt[0] }}?modestbranding=1" frameborder="0" title="{{ pyt[1] | escape }}"></iframe>
                {% endif %}

            <div class="alttext">{{ pyt[1] }}</div>




        </figure>
        {% assign orgCounter = orgCounter | plus: 1  %}
    {% endfor %}


  {% assign image_count = product.media | where: "media_type", "image" | size %}
  {% if image_count > 0 and gallery_click_to_zoom != 'disabled' %}
    <button
      class="
        product-gallery--expand
        {% if gallery_click_to_zoom == 'desktop' %}expand--hide-mobile{% endif %}
        {% if gallery_click_to_zoom == 'mobile' %}expand--hide-desktop{% endif %}
      "
      data-gallery-expand aria-haspopup="true"
    >
      <span class="click-text" tabindex="-1">
        {% render 'icon-library', id: 'icon-zoom' %}
        {{ 'product.general.zoom' | t }}
      </span>
      <span class="tap-text" tabindex="-1">
        {% render 'icon-library', id: 'icon-tap' %}
        {{ 'product.general.zoomTapMobile' | t }}
      </span>
    </button>
  {% endif %}
</div>

{% if gallery_hover_zoom == 'separate' %}
  <div class="product-gallery--zoomed-image" data-zoomed-image></div>
{% endif %}
